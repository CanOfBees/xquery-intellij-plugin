<!DOCTYPE idea-plugin PUBLIC "Plugin/DTD" "https://plugins.jetbrains.com/plugin.dtd">
<idea-plugin xmlns:xi="http://www.w3.org/2001/XInclude">
  <id>uk.co.reecedunn.intellij.plugin.xquery</id>
  <!--suppress PluginXmlValidity -->
  <name>xquery-intellij-plugin</name>
  <version>VERSION</version>
  <vendor email="msclrhd@gmail.com" url="http://reecedunn.co.uk">Reece H. Dunn</vendor>

  <description><![CDATA[
    XQuery 1.0, 3.0, and 3.1 language support with error recovery and support
    for: Full Text 1.0, and 3.0; Update Facility 1.0, and 3.0; Scripting
    Extension 1.0. Supports the BaseX, MarkLogic 6.0 to 8.0, and Saxonica
    XQuery vendor extensions.
  ]]></description>

  <change-notes><![CDATA[
    <h3>Release 1.5-dev:</h3>
    <p>References, Resolving and Find Usages:</p>
    <ol>
      <li>Fix resolving and finding usages of variables declared in imported modules.</li>
      <li>Fix find usages of locally declared and imported functions.</li>
      <li>Support the MarkLogic behaviour for resolving <code>NCName</code>-based <code>FunctionDecl</code>s.</li>
      <li>Fix resolving to imported functions from declarations other than the one declaring the namespace.</li>
      <li>Provide better type names in the find usages pane.</li>
      <li>Display the <code>EQName</code> type signature in the find usages pane.</li>
    </ol>
    <p>IntelliJ Integration:</p>
    <ol>
      <li>File structure support, listing the declared functions, variables, and types, and the query body in a file.</li>
      <li>Display the functions, variables, and types when "Show Members" is enabled in the project pane.</li>
      <li>Display the function signature when holding Ctrl over a function call.</li>
      <li>Display the variable signature when holding Ctrl over a variable reference.</li>
      <li>Use the QName annotator on Wildcard elements to correctly highlight the namespace prefix and local name parts.</li>
    </ol>
    <p>Code Completion:</p>
    <ol>
      <li>In-scope variable completion support in <code>VarRef</code> expressions for XQuery.</li>
      <li>Statically-known function completion support in <code>FunctionCall</code> and <code>ArrowExpr</code> expressions for XQuery.</li>
      <li>XML Schema and <code>union()</code> type completion support in <code>AtomicOrUnionType</code> and <code>SimpleTypeName</code> for XPath and XQuery.</li>
      <li>Namespace prefix completion support in <code>QName</code>s for XPath and XQuery.</li>
      <li>Keyword completion support in <code>ForwardAxis</code> and <code>ReverseAxis</code> for XPath and XQuery.</li>
      <li>Keyword completion support in <code>KindTest</code> based <code>NodeTest</code>s and <code>ItemType</code>s for XPath and XQuery.</li>
      <li>Keyword completion support in <code>SequenceType</code>s for XPath and XQuery.</li>
    </ol>
    <p>Run Configurations:</p>
    <ol>
      <li>Link to the files when displaying query errors in the console.</li>
      <li>Support running XPath queries as XSLT patterns (XPath subset) on the Saxon query processor.</li>
      <li>Support profiling Saxon XSLT and XQuery scripts.</li>
      <li>Display the elapsed time and number of items returned by the query in the results console.</li>
      <li>Include the console output when profiling queries.</li>
    </ol>
    <p>Query Processor Integration:</p>
    <ol>
      <li>Add a query log viewer for BaseX and MarkLogic log files.</li>
    </ol>
    <p>Saxon:</p>
    <ol>
      <li>Fix using Saxon 9.2 to 9.8 JAR files.</li>
      <li>
        Disable Saxon EE optimizations to prevent the processor throwing a <code>NoClassDefFoundError</code>
        looking for <code>com/saxonica/ee/bytecode/GeneratedCode</code>.
      </li>
      <li>Support <code>union(...)</code> types in XPath expressions.</li>
      <li>Support <code>union(...)</code> types in <code>SingleType</code>s for XPath and XQuery.</li>
    </ol>
    <p>BaseX:</p>
    <ol>
      <li>Add definitions for the BaseX 9.2 built-in functions.</li>
      <li>Add support for the <code>perm</code> annotations introduced in BaseX 9.0.</li>
    </ol>
    <p>MarkLogic:</p>
    <ol>
      <li>Add definitions for the MarkLogic 10.0-1 built-in functions.</li>
      <li>Fix MarkLogic 6.0 <code>binary()</code> used as a <code>NodeTest</code>.</li>
      <li>Support the MarkLogic 6.0 <code>validate full</code> syntax extension.</li>
    </ol>
    <p>XPath and XSLT:</p>
    <ol>
      <li>
        Enable XPath syntax validation of expressions and patterns in XSLT when the XPath View + XSLT plugin
        is disabled.
      </li>
      <li>Full Text 1.0 and 3.0 extensions support in the XPath lexer and parser.</li>
    </ol>
    <p>XPath and XQuery:</p>
    <ol>
      <li>Fix parsing decimal <code>CharRef</code>s with a single digit, e.g. <code>"&#9;"</code>.</li>
      <li>Report an error when the <code>EnclosedExpr</code> is missing from named computed constructors.</li>
      <li>
        Report a parser error when a <code>NumericLiteral</code> is followed by an <code>NCName</code> or
        <code>URIQualifiedName</code> without whitespace or comment tokens, due to them being non-delimiting
        terminal symbols.
      </li>
      <li>Report an error if an unknown axis name is followed by the <code>::</code> axis indicator.</li>
    </ol>
    <p>Inspections:</p>
    <ol>
      <li>XPST0017: Enable the undefined function inspection by default.</li>
      <li>XQST0047: Don't generate an error on <code>ModuleImport</code>s without a namespace prefix.</li>
    </ol>
  ]]></change-notes>

  <idea-version since-build="161"/>

  <depends>com.intellij.modules.lang</depends>
  <depends>com.intellij.modules.xdebugger</depends>
  <depends>com.intellij.modules.xml</depends>

  <extensionPoints>
    <extensionPoint qualifiedName="uk.co.reecedunn.intellij.importPathResolver" interface="uk.co.reecedunn.intellij.plugin.xpath.model.ImportPathResolver"/>
    <extensionPoint qualifiedName="uk.co.reecedunn.intellij.queryProcessorApi" interface="uk.co.reecedunn.intellij.plugin.processor.query.QueryProcessorApi"/>
  </extensionPoints>

  <xi:include href="plugin-filetypes.xml" xpointer="xpointer(/idea-plugin/*)"/>

  <extensions defaultExtensionNs="com.intellij">
    <!-- XML Path Language Support -->

    <lang.ast.factory language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.xpath.parser.XPathASTFactory"/>
    <lang.parserDefinition language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.xpath.parser.XPathParserDefinition"/>

    <lang.syntaxHighlighterFactory language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lexer.XPathSyntaxHighlighterFactory"/>
    <colorSettingsPage implementation="uk.co.reecedunn.intellij.plugin.intellij.settings.XPathColorSettingsPage"/>
    <annotator language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.xpath.annotation.QNameAnnotator"/>

    <lang.foldingBuilder language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lang.foldable.FoldingBuilderImpl"/>

    <!-- XML Query Language Support -->

    <lang.ast.factory language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.xquery.parser.XQueryASTFactory"/>
    <lang.parserDefinition language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.xquery.parser.XQueryParserDefinition"/>
    <lang.findUsagesProvider language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lang.findUsages.XQueryFindUsagesProvider"/>

    <lang.syntaxHighlighterFactory language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lexer.XQuerySyntaxHighlighterFactory"/>
    <colorSettingsPage implementation="uk.co.reecedunn.intellij.plugin.intellij.settings.XQueryColorSettingsPage"/>
    <annotator language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.xquery.annotation.QNameAnnotator"/>

    <lang.braceMatcher language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lang.XQueryPairedBraceMatcher"/>
    <lang.commenter language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lang.XQueryCommenter"/>
    <lang.foldingBuilder language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.lang.foldable.FoldingBuilderImpl"/>

    <lang.psiStructureViewFactory language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.ide.structureView.XQueryStructureViewFactory"/>
    <treeStructureProvider implementation="uk.co.reecedunn.intellij.plugin.intellij.ide.projectView.XQueryTreeStructureProvider"/>

    <completion.contributor language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.xquery.completion.XQueryCompletionContributor"/>

    <lang.documentationProvider language="XQuery" implementationClass="uk.co.reecedunn.intellij.plugin.intellij.documentation.XQueryDocumentationProvider"/>

    <!-- XSLT Language Support -->

    <standardResourceProvider implementation="uk.co.reecedunn.intellij.plugin.intellij.javaee.XsltResourceProvider"/>

    <multiHostInjector implementation="uk.co.reecedunn.intellij.plugin.intellij.lang.injection.XPathInXsltLanguageInjection"/>

    <completion.contributor language="XMLPath" implementationClass="uk.co.reecedunn.intellij.plugin.xpath.completion.XPathCompletionContributor"/>

    <!-- References and Resolve -->

    <lang.elementManipulator forClass="uk.co.reecedunn.intellij.plugin.xquery.psi.impl.xquery.XQueryUriLiteralPsiImpl"
                             implementationClass="uk.co.reecedunn.intellij.plugin.xquery.psi.manipulator.XQueryUriLiteralManipulator"/>
    <lang.elementManipulator forClass="uk.co.reecedunn.intellij.plugin.xquery.psi.impl.xquery.XQueryQNamePsiImpl"
                             implementationClass="uk.co.reecedunn.intellij.plugin.xquery.psi.manipulator.XQueryQNameManipulator"/>
    <lang.elementManipulator forClass="uk.co.reecedunn.intellij.plugin.xquery.psi.impl.xquery.XQueryNCNamePsiImpl"
                             implementationClass="uk.co.reecedunn.intellij.plugin.xquery.psi.manipulator.XQueryNCNameManipulator"/>

    <!-- Inspections -->

    <localInspection language="XQuery" shortName="IJVS0001" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.ijvs.group-name" groupPath="XPath and XQuery"
                     key="inspection.ijvs.IJVS0001" hasStaticDescription="true"
                     enabledByDefault="true" level="WARNING"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.ijvs.IJVS0001"/>
    <localInspection language="XQuery" shortName="IJVS0002" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.ijvs.group-name" groupPath="XPath and XQuery"
                     key="inspection.ijvs.IJVS0002" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.ijvs.IJVS0002"/>
    <localInspection language="XQuery" shortName="IJVS0003" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.ijvs.group-name" groupPath="XPath and XQuery"
                     key="inspection.ijvs.IJVS0003" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.ijvs.IJVS0003"/>
    <localInspection language="XQuery" shortName="IJVS0004" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.ijvs.group-name" groupPath="XPath and XQuery"
                     key="inspection.ijvs.IJVS0004" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.ijvs.IJVS0004"/>
    <localInspection language="XQuery" shortName="IJVS0005" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.ijvs.group-name" groupPath="XPath and XQuery"
                     key="inspection.ijvs.IJVS0005" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.ijvs.IJVS0005"/>

    <localInspection language="XQuery" shortName="XPST0017" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xpst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xpst.XPST0017" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.xpst.XPST0017"/>
    <localInspection language="XQuery" shortName="XQST0031" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xqst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xqst.XQST0031" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xquery.codeInspection.xqst.XQST0031"/>
    <localInspection language="XQuery" shortName="XQST0033" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xqst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xqst.XQST0033" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xquery.codeInspection.xqst.XQST0033"/>
    <localInspection language="XQuery" shortName="XQST0047" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xqst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xqst.XQST0047" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xquery.codeInspection.xqst.XQST0047"/>
    <localInspection language="XQuery" shortName="XPST0081" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xpst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xpst.XPST0081" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xpath.codeInspection.xpst.XPST0081"/>
    <localInspection language="XQuery" shortName="XQST0118" bundle="messages.XQueryPluginBundle"
                     groupKey="inspection.xqst.group-name" groupPath="XPath and XQuery"
                     key="inspection.xqst.XQST0118" hasStaticDescription="true"
                     enabledByDefault="true" level="ERROR"
                     implementationClass="uk.co.reecedunn.intellij.plugin.xquery.codeInspection.xqst.XQST0118"/>

    <!-- Application / Project Settings -->

    <projectService serviceInterface="uk.co.reecedunn.intellij.plugin.intellij.settings.XQueryProjectSettings"
                    serviceImplementation="uk.co.reecedunn.intellij.plugin.intellij.settings.XQueryProjectSettings"/>
    <projectConfigurable groupId="language" displayName="XQuery" instance="uk.co.reecedunn.intellij.plugin.intellij.settings.XQueryProjectSettingsConfigurable"/>

    <applicationService serviceImplementation="uk.co.reecedunn.intellij.plugin.intellij.settings.QueryProcessors"/>

    <!-- Run/Debug Configurations -->

    <executor implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.executors.DefaultProfileExecutor"/>

    <programRunner implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.runners.QueryProcessorRunner"/>
    <programRunner implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.runners.QueryProcessorDebugger"/>
    <programRunner implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.runners.QueryProcessorProfiler"/>

    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.ServerSideJavaScriptConfigurationType"/>
    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.SPARQLConfigurationType"/>
    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.SQLConfigurationType"/>
    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.XPathConfigurationType"/>
    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.XQueryConfigurationType"/>
    <configurationType implementation="uk.co.reecedunn.intellij.plugin.intellij.execution.configurations.type.XSLTConfigurationType"/>

    <!-- Log Viewer -->

    <toolWindow id="Query Log" anchor="bottom" secondary="true" factoryClass="uk.co.reecedunn.intellij.plugin.intellij.log.QueryLogViewer"/>
  </extensions>

  <extensions defaultExtensionNs="uk.co.reecedunn.intellij">
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.xquery.model.Annotations"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.expath.model.BuiltInFunctions"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.exquery.model.BuiltInFunctions"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.w3.model.BuiltInFunctions"/>

    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.basex.model.BuiltInFunctions"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.existdb.model.BuiltInFunctions"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.marklogic.model.BuiltInFunctions"/>
    <importPathResolver implementation="uk.co.reecedunn.intellij.plugin.saxon.model.BuiltInFunctions"/>

    <queryProcessorApi implementation="uk.co.reecedunn.intellij.plugin.basex.query.session.BaseXSession"/>
    <queryProcessorApi implementation="uk.co.reecedunn.intellij.plugin.existdb.query.rest.EXistDBRest"/>
    <queryProcessorApi implementation="uk.co.reecedunn.intellij.plugin.marklogic.query.rest.MarkLogicRest"/>
    <queryProcessorApi implementation="uk.co.reecedunn.intellij.plugin.saxon.query.s9api.SaxonS9API"/>
  </extensions>
</idea-plugin>
